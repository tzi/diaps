const Diaps=function(selector,onStart){const Layer=function(node,layerClass){const layerElement=document.createElement("div");layerElement.classList.add("diaps__layer",`diaps__layer--${layerClass}`);node.appendChild(layerElement);const container={};container.media=Container(layerElement);container.text=Container(layerElement);return{container:container}};const Container=function(layerNode){const contentList=[];const add=function(node,animation,onStart){const content=document.createElement("div");content.appendChild(node);content.classList.add("diaps__content");layerNode.appendChild(content);return function addContent(){onStart(node);contentList.push(content);if(!animation||_isQuiet){return true}content.classList.add("animated",animation);window.requestAnimationFrame(function(){content.addEventListener("animationend",()=>{content.classList.remove(animation)})})}};const querying=function(query){if(query&&query.tagName){return query}if(query==="first"){return contentList[0]}return contentList[contentList.length-1]};const animate=function(query,animation=false,onEnd=false){const content=querying(query);return function animateContent(){if(!content){return true}if(!animation||_isQuiet){if(onEnd){onEnd(content)}return true}content.classList.add("animated",animation);if(onEnd){window.requestAnimationFrame(()=>{content.addEventListener("animationend",()=>{onEnd(content)})})}}};const remove=function(query,animation=false){return function(){const content=querying(query);contentList.splice(contentList.indexOf(content),1);console.log(content);animate(content,animation,function(){content.parentNode.removeChild(content)})()}};return{add:add,animate:animate,remove:remove}};const NewContent=function(node,type=false,onStart=false){const add=function(layer,animation=false){const container=layer.container[type];return container.add(node,animation,onStart)};const slideInUp=function(layer){return add(layer,"slideInUp")};const slideInRight=function(layer){return add(layer,"slideInRight")};const slideInLeft=function(layer){return add(layer,"slideInLeft")};const slideInDown=function(layer){return add(layer,"slideInDown")};const bounceIn=function(layer){return add(layer,"bounceIn")};const fadeIn=function(layer){return add(layer,"fadeIn")};const zoomIn=function(layer){return add(layer,"zoomIn")};return{to:add,slideInUp:slideInUp,slideInLeft:slideInLeft,slideInRight:slideInRight,slideInDown:slideInDown,bounceIn:bounceIn,fadeIn:fadeIn,zoomIn:zoomIn}};const ExistingContent=function(container,query="last"){const remove=function(animation=false){return container.remove(query,animation)};const animate=function(animation){return container.animate(query,animation)};const slideOutUp=function(){return remove("slideOutUp")};const slideOutRight=function(){return remove("slideOutRight")};const slideOutLeft=function(){return remove("slideOutLeft")};const slideOutDown=function(){return remove("slideOutDown")};const bounce=function(){return animate("bounce")};const bounceOut=function(){return remove("bounceOut")};const fadeOut=function(){return remove("fadeOut")};return{remove:remove,slideOutUp:slideOutUp,slideOutLeft:slideOutLeft,slideOutRight:slideOutRight,slideOutDown:slideOutDown,bounce:bounce,bounceOut:bounceOut,fadeOut:fadeOut}};const Image={};Image.add=function(src,...extraClasses){const img=document.createElement("img");img.classList.add("diaps__media",...extraClasses);img.src=src;img.style.opacity=0;return NewContent(img,"media",()=>{img.style.opacity=1})};Image.from=function(layer){return ExistingContent(layer.container.media)};Image.first=function(layer){return ExistingContent(layer.container.media,query="first")};const Video={};Video.add=function(src,...extraClasses){const video=document.createElement("video");video.classList.add("diaps__media",...extraClasses);video.src=src;video.style.opacity=0;return NewContent(video,"media",()=>{video.style.opacity=1;video.play()})};Video.from=function(layer){return ExistingContent(layer.container.media)};Video.first=function(layer){return ExistingContent(layer.container.media,query="first")};const Text={};Text.add=function add(text,...extraClasses){const div=document.createElement("div");div.classList.add("diaps__text",...extraClasses);return NewContent(div,"text",()=>{div.innerHTML=text})};Text.from=function from(layer){return ExistingContent(layer.container.text)};Text.first=function(layer){return ExistingContent(layer.container.media,query="first")};const Sound={};Sound.add=function add(src){return function(){if(!_isQuiet){const audio=new Audio(src);audio.play()}}};const initialize=function(){const startButton=node.querySelector(".diaps__start");const timer=Timer(".diaps__timer");let chain=TimeChain();onStart(chain.wait(1),controls).exec(timer.stop);if(window.location.hash){const hash=parseInt(window.location.hash.slice(1));if(!isNaN(hash)){setIsQuiet(true);chain=chain.fastForward(hash);setIsQuiet(false);timer.set(hash);if(!chain){startButton.parentNode.removeChild(startButton)}}}startButton.addEventListener("animationend",function(){if(chain.isActive()){startButton.style.display="none"}});chain.onStart(function(){timer.start();startButton.classList.remove("zoomIn");startButton.classList.add("animated","zoomOut")});chain.onPause(function(){timer.stop();startButton.style.display="block";window.requestAnimationFrame(()=>{startButton.classList.remove("zoomOut");startButton.classList.add("animated","zoomIn")})});startButton.addEventListener("click",chain.start);document.addEventListener("keypress",function(event){if(event.which===32){if(!chain.toggle()){window.location.hash=`#${timer.getTime()}`}}})};const setIsQuiet=function(isQuiet){_isQuiet=isQuiet};const node=document.querySelector(selector);node.classList.add("diaps");node.innerHTML=`\n<button type="button" class="diaps__start">\n    <svg version="1.1" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 30 30">\n        <path d="M19.982,14.438l-6.24-4.536c-0.229-0.166-0.533-0.191-0.784-0.062c-0.253,0.128-0.411,0.388-0.411,0.669v9.069\nc0,0.284,0.158,0.543,0.411,0.671c0.107,0.054,0.224,0.081,0.342,0.081c0.154,0,0.31-0.049,0.442-0.146l6.24-4.532\nc0.197-0.145,0.312-0.369,0.312-0.607C20.295,14.803,20.177,14.58,19.982,14.438z"></path>\n<path d="M15.026,0.002C6.726,0.002,0,6.728,0,15.028c0,8.297,6.726,15.021,15.026,15.021c8.298,0,15.025-6.725,15.025-15.021\nC30.052,6.728,23.324,0.002,15.026,0.002z M15.026,27.542c-6.912,0-12.516-5.601-12.516-12.514c0-6.91,5.604-12.518,12.516-12.518\nc6.911,0,12.514,5.607,12.514,12.518C27.541,21.941,21.937,27.542,15.026,27.542z"></path>\n    </svg>\n</button>\n<div class="diaps__timer"></div>`;const layers={};layers.background=Layer(node,"background");layers.center=Layer(node,"center");layers.top=Layer(node,"top");layers.left=Layer(node,"left");layers.right=Layer(node,"right");layers.bottom=Layer(node,"bottom");layers.nw=Layer(node,"nw");layers.ne=Layer(node,"ne");layers.se=Layer(node,"se");layers.sw=Layer(node,"sw");let _isQuiet=false;const controls={Image:Image,Video:Video,Text:Text,Sound:Sound,layers:layers,setIsQuiet:setIsQuiet};initialize()};const TimeChain=function(){let _next;let _resolved=false;let _time=0;let _callback;let _timeout;const _startHandler=[];const _pauseHandler=[];const wait=function(time){_time+=time;return this};const exec=function(callback=false){_callback=callback;_next=TimeChain();return _next};const delayed=function(callback,delay){return exec(function(){setTimeout(callback,delay*1e3)})};const sequence=function(callback,dataList){const chain=TimeChain();let step=chain;dataList.forEach((data,index)=>step=callback(step,data,index,dataList));_next=chain;return step};const getNext=function(){return _next};const getCurrent=function(){if(_resolved&&_next){return _next.getCurrent()}return this};const fastForward=function(until){if(until-_time>0){_resolved=true;if(_callback){_callback()}if(_next){return _next.fastForward(until-_time)}return false}wait(_time-until);return this};const resolve=function(){_resolved=true;if(_callback){_callback()}if(_next){_next.start()}};const onStart=function(handler){_startHandler.push(handler)};const start=function(){if(!_resolved){if(_time===0){resolve()}else{_timeout=setTimeout(resolve,_time*1e3)}}_startHandler.forEach(handler=>handler())};const onPause=function(handler){_pauseHandler.push(handler)};const pause=function(){if(!_resolved){clearTimeout(_timeout);_timeout=null}_pauseHandler.forEach(handler=>handler())};const toggle=function(force){const current=getCurrent.call(this);if(current.isActive()||force===false){pause();current.pause();return false}start();current.start();return true};const isActive=function(){return!!_timeout};const debug=function(){if(_time){console.log(`wait ${_time}s`)}if(_callback&&_callback.name){console.log(`exec ${_callback.name}()`)}if(_next){return _next.debug()}};return{wait:wait,exec:exec,delayed:delayed,sequence:sequence,getNext:getNext,getCurrent:getCurrent,start:start,onPause:onPause,pause:pause,toggle:toggle,isActive:isActive,onStart:onStart,fastForward:fastForward,debug:debug}};const Timer=function(selector){const _node=document.querySelector(selector);let _time=0;let _interval;const set=function(time){_time=time;update()};const start=function(){if(!_interval){update();_interval=setInterval(()=>{_time++;update()},1e3)}};const update=function(){_node.innerHTML=`${_time}s`};const stop=function(){clearInterval(_interval);_interval=null};const toggle=function(force){if(_interval||force===false){stop();return false}start();return true};const getTime=function(){return _time};return{set:set,start:start,stop:stop,toggle:toggle,getTime:getTime}};
